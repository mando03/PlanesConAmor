---
import { Mail, Sparkles, X } from "@lucide/astro";
---

<section
  id="waitlist"
  class="relative overflow-hidden bg-linear-to-br from-amber-50 via-rose-50 to-purple-50 px-4 py-32"
>
  <div class="absolute top-0 left-0 h-full w-full">
    <div
      class="absolute top-20 left-20 h-64 w-64 rounded-full bg-amber-200/20 blur-3xl"
    >
    </div>
    <div
      class="absolute right-20 bottom-20 h-80 w-80 rounded-full bg-rose-200/20 blur-3xl"
    >
    </div>
  </div>

  <div class="relative z-10 mx-auto max-w-3xl">
    <div class="mb-12 text-center">
      <div
        class="mb-6 inline-flex items-center gap-2 rounded-full border border-amber-200 bg-white/80 px-4 py-2 backdrop-blur-sm md:px-6 md:py-3"
      >
        <Sparkles class="h-4 w-4 text-amber-600 md:h-5 md:w-5" />
        <span
          class="font-cutive-mono text-sm font-medium text-amber-900 md:text-base"
          >Acceso anticipado</span
        >
      </div>

      <h2
        class="font-fredericka mb-6 text-5xl font-bold text-balance md:text-7xl"
      >
        Sé de los primeros en{" "}
        <span
          class="bg-linear-to-r from-amber-600 to-rose-600 bg-clip-text text-transparent"
        >
          crear recuerdos
        </span>
      </h2>
      <p class="font-cutive text-base text-pretty text-gray-600 xl:text-xl">
        Únete a nuestra lista de espera y recibe noticias, actualizaciones y
        acceso exclusivo cuando lancemos.
      </p>
    </div>

    <!-- Formulario -->
    <form
      id="waitlist-form"
      class="mx-auto flex max-w-xl flex-col gap-3 sm:flex-row"
    >
      <div class="relative flex-1">
        <Mail
          class="absolute top-1/2 left-4 h-5 w-5 -translate-y-1/2 text-gray-500"
        />
        <input
          id="email-input"
          type="email"
          name="email"
          placeholder="tu@email.com"
          required
          class="font-cutive-mono h-14 w-full rounded-md border-2 border-gray-300 pr-4 pl-12 text-xl transition-colors outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-200 md:text-2xl"
        />
      </div>

      {/* Honeypot: campo oculto para detectar bots */}
      <input
        type="text"
        name="website"
        tabindex="-1"
        autocomplete="off"
        class="absolute -left-2499.75 h-0 w-0 opacity-0"
        aria-hidden="true"
      />

      <button
        id="submit-button"
        type="submit"
        class="font-cutive h-14 rounded-md bg-linear-to-r from-amber-600 to-rose-600 px-8 text-base font-medium text-white transition-all hover:from-amber-700 hover:to-rose-700 disabled:cursor-not-allowed disabled:opacity-50"
      >
        <span id="button-text">Unirme ahora</span>
        <span id="button-loading" class="hidden">Enviando...</span>
      </button>
    </form>

    <div class="mt-12 text-center">
      <p class="font-cutive text-sm text-gray-600">
        Únete a <span class="font-bold text-gray-900">500+</span> personas esperando
        crear recuerdos inolvidables
      </p>
    </div>
  </div>
</section>

<!-- Modal de Resultado (oculto por defecto) -->
<div
  id="result-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4 backdrop-blur-sm"
  role="dialog"
  aria-modal="true"
>
  <div
    class="animate-fade-in relative w-full max-w-md rounded-2xl border-2 bg-white p-8 shadow-2xl"
  >
    {/* Botón cerrar */}
    <button
      id="close-modal"
      type="button"
      class="absolute top-4 right-4 rounded-full p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600"
      aria-label="Cerrar"
    >
      <X class="h-5 w-5" />
    </button>

    {/* Contenido del modal - Se llena dinámicamente */}
    <div id="modal-content"></div>
  </div>
</div>

<script>
  import { actions } from "astro:actions";

  const form = document.getElementById("waitlist-form") as HTMLFormElement;
  const submitButton = document.getElementById(
    "submit-button"
  ) as HTMLButtonElement;
  const buttonText = document.getElementById("button-text") as HTMLElement;
  const buttonLoading = document.getElementById(
    "button-loading"
  ) as HTMLElement;
  const modal = document.getElementById("result-modal") as HTMLElement;
  const modalContent = document.getElementById("modal-content") as HTMLElement;
  const closeButton = document.getElementById("close-modal") as HTMLElement;

  // Interceptar submit del formulario
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Estado de loading
    submitButton.disabled = true;
    buttonText.classList.add("hidden");
    buttonLoading.classList.remove("hidden");

    try {
      const formData = new FormData(form);
      const { error } = await actions.joinWaitlist(formData);

      // Mostrar modal con resultado
      if (error) {
        showModal("error", error.message);
      } else {
        showModal("success", "");
        form.reset();
      }
    } catch {
      showModal("error", "Ocurrió un error inesperado. Intenta nuevamente.");
    } finally {
      // Restaurar botón
      submitButton.disabled = false;
      buttonText.classList.remove("hidden");
      buttonLoading.classList.add("hidden");
    }
  });

  // Función para mostrar modal
  function showModal(type: "success" | "error", message: string) {
    if (type === "success") {
      modalContent.innerHTML = `
        <div class="text-center">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-linear-to-br from-emerald-400 to-teal-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/><path d="M20 3v4"/><path d="M22 5h-4"/><path d="M4 17v2"/><path d="M5 18H3"/></svg>
          </div>
          <h3 class="font-fredericka mb-3 text-3xl font-bold text-gray-900">
            ¡Bienvenido a la comunidad!
          </h3>
          <p class="font-cutive text-base text-gray-600">
            Te notificaremos cuando estemos listos para lanzar. Revisa tu
            correo para estar al tanto de las últimas noticias y
            actualizaciones.
          </p>
        </div>
      `;
    } else {
      modalContent.innerHTML = `
        <div class="text-center">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
          </div>
          <h3 class="font-fredericka mb-3 text-2xl font-bold text-gray-900">
            Oops, algo salió mal
          </h3>
          <p class="font-cutive text-base text-red-800">${message}</p>
        </div>
      `;
    }

    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  // Cerrar modal
  closeButton.addEventListener("click", () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });

  // Cerrar al hacer click en el overlay
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      closeButton.click();
    }
  });

  // Cerrar con la tecla Escape
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal.classList.contains("flex")) {
      closeButton.click();
    }
  });
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.2s ease-out;
  }
</style>
