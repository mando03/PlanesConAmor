---
import { Mail, Sparkles, AlertCircle, X } from "@lucide/astro";
import { actions } from "astro:actions";

const result = Astro.getActionResult(actions.joinWaitlist);
const isSuccess = result && !result.error;
const errorMessage = result?.error?.message;
const hasResult = isSuccess || errorMessage;
---

<section
  id="waitlist"
  class="relative overflow-hidden bg-linear-to-br from-amber-50 via-rose-50 to-purple-50 px-4 py-32"
>
  <div class="absolute top-0 left-0 h-full w-full">
    <div
      class="absolute top-20 left-20 h-64 w-64 rounded-full bg-amber-200/20 blur-3xl"
    >
    </div>
    <div
      class="absolute right-20 bottom-20 h-80 w-80 rounded-full bg-rose-200/20 blur-3xl"
    >
    </div>
  </div>

  <div class="relative z-10 mx-auto max-w-3xl">
    <div class="mb-12 text-center">
      <div
        class="mb-6 inline-flex items-center gap-2 rounded-full border border-amber-200 bg-white/80 px-4 py-2 backdrop-blur-sm md:px-6 md:py-3"
      >
        <Sparkles class="h-4 w-4 text-amber-600 md:h-5 md:w-5" />
        <span
          class="font-cutive-mono text-sm font-medium text-amber-900 md:text-base"
          >Acceso anticipado</span
        >
      </div>

      <h2
        class="font-fredericka mb-6 text-5xl font-bold text-balance md:text-7xl"
      >
        Sé de los primeros en{" "}
        <span
          class="bg-linear-to-r from-amber-600 to-rose-600 bg-clip-text text-transparent"
        >
          crear recuerdos
        </span>
      </h2>
      <p class="font-cutive text-base text-pretty text-gray-600 xl:text-xl">
        Únete a nuestra lista de espera y recibe noticas, actualizaciones y
        acceso exclusivo cuando lancemos.
      </p>
    </div>

    <!-- Formulario -->
    <form
      method="POST"
      action={actions.joinWaitlist}
      class="mx-auto flex max-w-xl flex-col gap-3 sm:flex-row"
    >
      <div class="relative flex-1">
        <Mail
          class="absolute top-1/2 left-4 h-5 w-5 -translate-y-1/2 text-gray-500"
        />
        <input
          type="email"
          name="email"
          placeholder="tu@email.com"
          required
          class="font-cutive-mono h-14 w-full rounded-md border-2 border-gray-300 pr-4 pl-12 text-xl transition-colors outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-200 md:text-2xl"
        />
      </div>

      {/* Honeypot: campo oculto para detectar bots */}
      <input
        type="text"
        name="website"
        tabindex="-1"
        autocomplete="off"
        class="absolute -left-2499.75 h-0 w-0 opacity-0"
        aria-hidden="true"
      />

      <button
        type="submit"
        class="font-cutive h-14 rounded-md bg-linear-to-r from-amber-600 to-rose-600 px-8 text-base font-medium text-white transition-all hover:from-amber-700 hover:to-rose-700"
      >
        Unirme ahora
      </button>
    </form>

    <div class="mt-12 text-center">
      <p class="font-cutive text-sm text-gray-600">
        Únete a <span class="font-bold text-gray-900">500+</span> personas esperando
        crear recuerdos inolvidables
      </p>
    </div>
  </div>
</section>

<!-- Modal de Resultado -->
{
  hasResult && (
    <div
      id="result-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm"
      role="dialog"
      aria-modal="true"
    >
      <div class="animate-fade-in relative w-full max-w-md rounded-2xl border-2 bg-white p-8 shadow-2xl">
        {/* Botón cerrar */}
        <button
          id="close-modal"
          type="button"
          class="absolute top-4 right-4 rounded-full p-2 text-gray-400 transition-colors hover:bg-gray-100 hover:text-gray-600"
          aria-label="Cerrar"
        >
          <X class="h-5 w-5" />
        </button>

        {/* Contenido del modal - Éxito */}
        {isSuccess && (
          <div class="text-center">
            <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-linear-to-br from-emerald-400 to-teal-400">
              <Sparkles class="h-8 w-8 text-white" />
            </div>
            <h3 class="font-fredericka mb-3 text-3xl font-bold text-gray-900">
              ¡Bienvenido a la comunidad!
            </h3>
            <p class="font-cutive text-base text-gray-600">
              Te notificaremos cuando estemos listos para lanzar. Revisa tu
              correo para estar al tanto de las últimas noticias y
              actualizaciones.
            </p>
          </div>
        )}

        {/* Contenido del modal - Error */}
        {errorMessage && (
          <div class="text-center">
            <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
              <AlertCircle class="h-8 w-8 text-red-600" />
            </div>
            <h3 class="font-fredericka mb-3 text-2xl font-bold text-gray-900">
              Oops, algo salió mal
            </h3>
            <p class="font-cutive text-base text-red-800">{errorMessage}</p>
          </div>
        )}
      </div>
    </div>
  )
}

<script>
  // Cerrar modal al hacer click en el botón o en el overlay
  const modal = document.getElementById("result-modal");
  const closeButton = document.getElementById("close-modal");

  if (modal && closeButton) {
    // Cerrar con el botón X
    closeButton.addEventListener("click", () => {
      modal.classList.add("opacity-0", "pointer-events-none");
      setTimeout(() => {
        modal.remove();
      }, 300);
    });

    // Cerrar al hacer click en el overlay (fondo oscuro)
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        closeButton.click();
      }
    });

    // Cerrar con la tecla Escape
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeButton.click();
      }
    });
  }
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.2s ease-out;
  }
</style>
